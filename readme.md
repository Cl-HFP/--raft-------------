# 基于raft一致性协议的分布式文件系统
raft协议的实现参考了原论文：Diego Ongaro and John Ousterhout. In Search of an Understandable Consensus Algorithm. Stanford University. 2014.    
文章链接：[https://web.stanford.edu/~ouster/cgi-bin/papers/raft-atc14]    
raft协议的过程可参考：Raft Github pages：[https://link.zhihu.com/?target=https%3A//raft.github.io/]     

## 整体架构图
![](https://gitee.com/he-fupeng123/Photos/raw/master/Photos/ssx-1.png)   

## 以文件写操作为例，系统的工作流程
![](https://gitee.com/he-fupeng123/Photos/raw/master/Photos/ss2.png)   

## 实现功能
### 基本要求和实现情况：
1）此次项目采用的是python编程语言，客户端的UI界面也是调用python的tkinter包进行实现； 
2）文件系统中不同节点之间的通信方式采用 RPC 模式，选择的是python的RPC，实际编程中也将此次项目常用的rpc操作进一步编写和封装进了rpc.py代码文件；
3）文件系统具备基本的文件操作模型包括：创建、删除、访问等功能；项目也增加了文件改名的操作；
4）作为文件系统的客户端要求具有缓存功能即文件信息首先在本地存储 搜索，作为缓存的介质可以是内存也可以是磁盘文件（项目中使用的是磁盘文件）； 
5）为了保证数据的可用性和文件系统性能，数据需要创建多个副本，且 在正常情况下，多个副本不在同一物理机器，多个副本之间能够保持一致性（可 选择最终一致性即延迟一致性也可以选择瞬时一致性即同时写）；
	项目中，在同一台主机上，通过在彼此隔离的不同文件夹模拟不同的物理机器（当然，如果有条件在多台主机下的真实环境下运行也是能实现的），不同的物理机器在各自的文件夹下运行自己本地的代码，且只能管理自己文件夹下的文件，不同的文件夹之间的文件数据传输仅通过RPC通信进行交互；多个副本之间的一致性通过实现Raft共识协议进行维持，因而项目最终实现的是强一致性（实时一致性）； 
6）支持多用户即多个客户端，文件可以并行读写（即包含文件锁）； 
项目中，可同时运行多个客户端，且客户端可区分“一般用户”和“服务器管理员”两个权限进行登录，“服务器管理员”权限可额外查看服务器集群信息和创建节点等；不同客户端对同一文件的访问，采用了读/写锁（共享/排他锁）实行访问控制，读/写锁的实现可见RWLock.py代码文件；
7）对于上述基本功能，可以在本地测试，利用多个进程模拟不同的节点， 需要有相应的测试命令或者测试用例，并有截屏或者 video 支持；
项目采用本地测试的方法，前面提到的不同副本所在节点的运行通过在从服务器(slave)中创建线程进行模拟运行，每个节点各自拥有一个文件夹表示其相应的物理存储位置，每个节点创建后均不断执行Raft协议（见raft_node.py）来维持数据一致性；测试用例和功能的展示，将结合报告里的截屏和报告外附上的video进行展示。

### 附加实现：
1）实现了缓存更新机制，采用了课程提到的基于拉式的方法，又称基于客户的协议，当客户端发起一个文件读写请求的时候，它首先检查自己的缓存（本地文件）是否有该文件，如果有，它将向服务器请求该文件的最新更新时间，如果该文件自缓存以来没有发生过更新（即已经是最新的），则直接使用缓存；否则，客户端将向服务器请求该文件；
2）实现了课程中提到的Raft共识方法，自副本节点创建以后，就不断执行Raft的协议流程，初始时均为candidate，经选举产生leader和follower；值得注意的是，课程和一般提到的Raft协议方法均主要是针对日志维持一致性，在具体实现并应用到维持文件数据一致性时，需要作出进一步的调整，才能应用到此项目中来，具体实现报告下文将进行具体阐述；
3）实现了访问权限控制，将权限区分为“一般用户”和“服务器管理员”，服务器端能够进行识别，“服务器器管理员”可额外查看集群信息和执行创建节点等操作；
4）实现了并发访问控制的读/写锁（共享锁/排他锁）；

## 客户端运行界面
![](https://gitee.com/he-fupeng123/Photos/raw/master/Photos/ss3.png)    

![](https://gitee.com/he-fupeng123/Photos/raw/master/Photos/ss4.png)
## 代码说明    
***************************************************
运行环境：
①Windows 11
②PyCharm Community Edition 2021.1 x64
***************************************************

1. ratf_node.py为运行ratf协议的节点实现，包含了完整的ratf协议流程实现，是整个项目的核心代码之一，由slaveServer.py程序调用以创建节点

2. “client1”“client2”文件夹代表两个不同物理位置的客户端，其目录下包含除端口配置数据外执行代码相同的client.py，以及不同的文本文件；

3. “group1”“group2”"group3"文件夹代表不同的集群，其下有除端口配置数据外执行代码相同的slaveServer.py，该代码运行从服务器程序；此外，包含的node*文件夹表示集群下的一个数据节点，每个数据节点存储集群下文件的一个副本；

4. "mainServer"文件夹下仅包含mainServer.py，运行后执行主服务器程序

5. config.py为一些端口配置数据

6. log.py封装了ratf协议维持操作记录一致性的日志记录操作

7. ratf_node.py为运行ratf协议的节点实现，包含了完整的ratf协议流程实现，是整个项目的核心代码，又slaveServer.py程序调用以创建节点

8. rpc.py封装了常用的RPC操作

9. RWLock.py封装了读写锁的实现